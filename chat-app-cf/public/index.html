<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Hono Chat</title>
    <style>
      :root {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      }
      body {
        margin: 0;
        display: grid;
        grid-template-rows: auto auto 1fr auto;
        height: 100vh;
      }
      header {
        padding: 12px 16px;
        border-bottom: 1px solid #e5e5e5;
        font-weight: 600;
      }
      #roomBar {
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        gap: 8px;
      }
      #log {
        padding: 12px 16px;
        overflow-y: auto;
      }
      .sys {
        color: #777;
        font-size: 12px;
      }
      form {
        display: flex;
        gap: 8px;
        padding: 12px;
        border-top: 1px solid #e5e5e5;
      }
      input,
      button {
        font-size: 16px;
      }
      input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
      }
      button {
        padding: 10px 14px;
        border: none;
        border-radius: 8px;
        background: #111;
        color: #fff;
      }
    </style>
  </head>
  <body>
    <header>Hono Chat (Workers + WebSockets)</header>

    <div id="roomBar">
      <input id="room" placeholder="room (e.g., general)" />
      <input id="name" placeholder="your name" />
      <button id="join">Join</button>
    </div>

    <div id="log"></div>

    <form id="sendForm">
      <input id="msg" placeholder="Type a message..." autocomplete="off" />
      <button type="submit">Send</button>
    </form>

    <script>
      const logEl = document.getElementById("log");
      const msgEl = document.getElementById("msg");
      const roomEl = document.getElementById("room");
      const nameEl = document.getElementById("name");
      const joinBtn = document.getElementById("join");
      const sendForm = document.getElementById("sendForm");

      let ws;
      const log = (text, cls) => {
        const p = document.createElement("p");
        if (cls) p.className = cls;
        p.textContent = text;
        logEl.appendChild(p);
        logEl.scrollTop = logEl.scrollHeight;
      };

      function connect(room, name) {
        if (ws) ws.close();
        const proto = location.protocol === "https:" ? "wss" : "ws";
        const url = `${proto}://${location.host}/ws/${encodeURIComponent(
          room
        )}?name=${encodeURIComponent(name)}`;
        ws = new WebSocket(url);
        ws.onopen = () => log(`connected to "${room}" as ${name}`, "sys");
        ws.onclose = () => log("disconnected", "sys");
        ws.onerror = () => log("socket error", "sys");
        ws.onmessage = (ev) => {
          try {
            const data = JSON.parse(ev.data);
            if (data.type === "sys") log(`[sys] ${data.text}`, "sys");
            else if (data.type === "chat") log(`${data.name}: ${data.text}`);
          } catch {
            log(ev.data);
          }
        };
      }

      joinBtn.addEventListener("click", () => {
        const room = roomEl.value.trim() || "general";
        const name = nameEl.value.trim() || "anon";
        connect(room, name);
      });

      sendForm.addEventListener("submit", (e) => {
        e.preventDefault();
        if (!ws || ws.readyState !== WebSocket.OPEN) return;
        const text = msgEl.value.trim();
        if (!text) return;
        ws.send(JSON.stringify({ type: "chat", text }));
        msgEl.value = "";
      });
    </script>
  </body>
</html>
